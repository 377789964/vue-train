{
  "version": 3,
  "sources": ["../src/effect.ts", "../../shared/src/index.ts", "../src/baseHandler.ts", "../src/reactive.ts", "../src/computed.ts", "../src/watch.ts"],
  "sourcesContent": ["import { DeprecationTypes } from \"vue\";\n\n// import { ReactiveEffect } from \"vue\";\nexport let activeEffect;\n\nfunction cleanupEffect(effect) {\n    // \u6BCF\u6B21\u6267\u884Ceffect\u4E4B\u524D\uFF0C\u5148\u6E05\u7406effect\u4E2D\u4F9D\u8D56\u7684\u6240\u6709\u5C5E\u6027\n    let { deps } = effect\n    \n    for(let i = 0; i<deps.length; i++) {\n        deps[i].delete(effect)\n    }\n}\n\nexport class ReactiveEffect {\n    public active = true;\n    public deps = [];\n    public parent = undefined\n    constructor(public fn, private scheduler) {}\n    run() {\n        if(!this.active) { // \u505C\u6B62\u64CD\u4F5C\n            return this.fn() // \u76F4\u63A5\u6267\u884C\u51FD\u6570\n        }\n        // \u5176\u4ED6\u72B6\u6001 \u610F\u5473\u7740\u662F\u6FC0\u6D3B\u7684\u72B6\u6001\n        try {\n            this.parent = activeEffect\n            activeEffect = this\n            cleanupEffect(this)\n            return this.fn()\n        } finally {\n            activeEffect = this.parent\n            this.parent = undefined\n        }\n        \n    }\n    stop() {\n        if (this.active) {\n            cleanupEffect(this) // \u9996\u5148\u6E05\u9664effect\n            this.active = false // \u4FEE\u6539\u4E3A\u5931\u6D3B\u72B6\u6001\n        } \n    }\n}\n// \u4F9D\u8D56\u6536\u96C6\u5C31\u662F\u5427\u5F53\u524D\u7684efect\u53D8\u6210\u5168\u5C40\u7684\uFF0C\u7A0D\u540E\u53D6\u503C\u7684\u65F6\u5019\u53EF\u4EE5\u62FF\u5230\u8FD9\u4E2A\nexport function effect(fn, options:any = {}) {\n    const _effect = new ReactiveEffect(fn, options.scheduler)\n    _effect.run(); // \u9ED8\u8BA4\u6267\u884C\u4E00\u6B21\n    // \u4FDD\u8BC1_effect\u6267\u884C\u7684\u65F6\u5019this\u5C31\u662F\u5F53\u524D\u7684effect\n    const runner = _effect.run.bind(_effect)\n    runner.effect = _effect\n    return runner\n}\n\n// let mapping = {\n//     target: {\n//         name: [activeEffect]\n//     }\n// }\nconst targetMap = new WeakMap();\nexport function track(target, key) {\n    if(!activeEffect) {\n        // \u8868\u793A\u53D6\u503C\u64CD\u4F5C\u4E0D\u5728effect\u4E2D\n        return\n    }\n    let depsMap = targetMap.get(target)\n    if(!depsMap) {\n        // WeakMap\u4E2D\u7684key\u53EA\u80FD\u662F\u5BF9\u620F\u90A3\u4E2A\uFF0C\u6240\u4EE5\u5F53\u524D\u4F7F\u7528map\u6570\u636E\u7C7B\u578B\n        targetMap.set(target, (depsMap = new Map()))\n    }\n    let dep = depsMap.get(key)\n    if(!dep) {\n        depsMap.set(key, (dep = new Set()))\n    }\n    // let shouldTrack = !dep.has(activeEffect)\n    // if(shouldTrack) {\n    //     dep.add(activeEffect)\n    //     activeEffect.deps.push(dep);\n    // }\n    trackEffect(dep)\n    // console.log(targetMap, depsMap, activeEffect)\n}\n\nexport function trackEffect(dep) {\n    let shouldTrack = !dep.has(activeEffect)\n    if(shouldTrack) {\n        dep.add(activeEffect)\n        activeEffect.deps.push(dep);\n    }\n}\n\nexport function trigger(target, key, newValue, oldValue) {\n    const depsMap = targetMap.get(target)\n    // console.log(depsMap, 'depsMap')\n    if(!depsMap) {\n        return\n    }\n    const dep = depsMap.get(key)\n     if(dep) {\n        triggerEffect(dep)\n     }\n}\nexport function triggerEffect(dep) {\n    const effects = [...dep]\n    effects.forEach(effect => {\n        // console.log(effect, 'trigger')\n        // \u5F53\u6211\u91CD\u65B0\u6267\u884Ceffect\u65F6\uFF0C\u4F1A\u5C06\u5F53\u524D\u7684effect\u653E\u5728\u5168\u5C40\u4E0AactiveEffect\n        // \u907F\u514D\u5F53\u524Defect\u4E2D\u4FEE\u6539\u4E86\u5F53\u524Dkey\u7684\u503C\uFF0C\u8FD9\u6837\u4F1A\u6B7B\u5FAA\u73AF\n        if (activeEffect != effect) {\n            // console.log(effect, 'effect')\n            if (!effect.scheduler) { // \u5982\u679C\u6CA1\u6709scheduler\u6267\u884Crun\n                effect.run()\n            } else { // \u5982\u679C\u6709scheduler\u5219\u6267\u884Cscheduler\u4E0D\u6267\u884Crun\n                effect.scheduler()\n            }\n        }\n        \n    });\n}\n\n// \u9ED8\u8BA4\u6267\u884C\u4E86\u4E00\u4E2Aset\uFF0C\u5728\u5F53\u524D\u7684set\u4E2D\u6E05\u7A7A\u4E86effect\uFF0C\u53C8\u5411\u6B64set\u4E2D\u6DFB\u52A0\u4E86\u4E00\u9879\n", "export function isObject(value) {\n    return value !== null && typeof value == 'object'\n}\n\nexport function isFunction(value) {\n    return typeof value === 'function'\n}\n", "import { isObject } from \"@vue/shared\";\nimport { activeEffect, track, trigger } from \"./effect\";\nimport { reactive, ReactiveFlags } from \"./reactive\"\n\nexport const mutableHandlers = {\n    get(target, key, receiver) { // \u7528\u6237\u53D6\u503C\u64CD\u4F5C\n        if (ReactiveFlags.IS_REACTIVE === key) {\n          return true\n        }\n        track(target, key)\n        let r = Reflect.get(target, key, receiver); // \u5904\u7406\u4E86this\u6307\u5411\u95EE\u9898\n        if (isObject(r)) { //\u53EA\u6709\u7528\u6237\u53BB\u503C\u7684\u65F6\u5019\u624D\u4F1A\u4E8C\u6B21\u4EE3\u7406\uFF0C\u4E0D\u7528\u62C5\u5FC3\u6027\u80FD\n            return reactive(r)\n        }\n        return r\n    },\n    set(target, key, value, receiver) {\n        // \u7528\u6237\u8D4B\u503C\u64CD\u4F5C\n        let oldValue = target[key] // \u6CA1\u6709\u4FEE\u6539\u4E4B\u524D\u7684\u503C\n        \n        // \u8FD4\u56DE\u503C\u662F\u5E03\u5C14\u7C7B\u578B\n        let r = Reflect.set(target, key, value, receiver)\n\n        if (oldValue !== value) {\n            trigger(target, key, value, oldValue)\n        }\n        return r\n    }\n}\n", "import { isObject } from \"@vue/shared\";\nimport { mutableHandlers } from \"./baseHandler\"\n\nexport const enum ReactiveFlags {\n    IS_REACTIVE = \"__v_isReactive\"\n}\n\nexport function isReactive(target) {\n    return !!(target && target[ReactiveFlags.IS_REACTIVE])\n}\n\n// const mutableHandlers = {\n//     get(target, key, receiver) {\n//         if (ReactiveFlags.IS_REACTIVE === key) {\n//           return true  \n//         }\n//         return Reflect.get(target, key, receiver);\n//     },\n//     set(target, key, value, receiver) {\n//         return Reflect.set(target, key, value, receiver);\n//     }\n// }\n\nconst reactiveMap = new WeakMap(); // key \u53EA\u80FD\u662F\u5BF9\u8C61\nexport function reactive(target) {\n    if (!isObject(target)) {\n        return target;\n    }\n   \n    // \u4EE3\u7406\u5BF9\u8C61\u7684\u8FD4\u56DE\u503C\u88AB\u4EE3\u7406\uFF0C\u8FD4\u56DE\u4E4B\u524D\u88AB\u4EE3\u7406\u7684\u7ED3\u679C\n    if (target[ReactiveFlags.IS_REACTIVE]) {\n        return target\n    } \n\n    // \u7F13\u5B58\u4E00\u4E0B\uFF0C\u4EE3\u7406\u8FC7\u7684\u5BF9\u8C61\uFF0C\u518D\u8FDB\u884C\u4EE3\u7406\u7684\u65F6\u5019\u76F4\u63A5\u62FF\u51FA\u6765\u8FD4\u56DE\u5373\u53EF\n    const existsProxy = reactiveMap.get(target);\n    if (existsProxy) {\n        return existsProxy;\n    }\n\n    // \u4EE3\u7406 \u6211\u901A\u8FC7\u4EE3\u7406\u5BF9\u8C61\u64CD\u4F5C\u5C5E\u6027 \u4F60\u4F1A\u53BB\u6E90\u5BF9\u8C61\u4E0A\u8FDB\u884C\u83B7\u53D6\n    const proxy = new Proxy(target, mutableHandlers);\n    reactiveMap.set(target, proxy);\n    \n    return proxy\n}\n\n\n", "import { isFunction } from '@vue/shared'\nimport { activeEffect, ReactiveEffect, trackEffect, triggerEffect } from './effect';\n\nconst noop = () => {}\n\nclass ComputedRefImpl {\n    public dep = undefined;\n    public effect = undefined;\n    public __v_isRef = true; // \u6709\u8FD9\u4E2A\u5C5E\u6027\u8868\u793A\u9700\u8981\u7528.value\u53D6\u503C\n    public _ditry = true;\n    public _value; // \u9ED8\u8BA4\u7684\u7F13\u5B58\u7ED3\u679C\n    constructor(getter, public setter) {\n        // \u8FD9\u91CC\u6E90\u7801\u4E2D\u4E0D\u80FD\u4F7F\u7528effect(() => {}),\u56E0\u4E3A\u529F\u80FD\u662F\u8BBF\u95EE\u624D\u4F1A\u6267\u884C\u4E0D\u662F\u9ED8\u8BA4\u6267\u884C\n        this.effect = new ReactiveEffect(getter, ()=>{\n            this._ditry = true\n            //  \u5982\u679C\u503C\u88AB\u4FEE\u6539\u4E86\uFF0C\u624B\u52A8\u6267\u884C\u8BA1\u7B97\u5C5E\u6027\u4F9D\u8D56\u7684effect\n            triggerEffect(this.dep)\n        })\n    }\n    // vue2\u7684\u5C5E\u6027\u8BBF\u95EE\u5668\uFF0CdefineProperty(\u5B9E\u4F8B, vlaue, {get})\n    get value() { // \u53D6\u503C\u624D\u6267\u884C\n        if (activeEffect) {\n            // \u5982\u679C\u6709activeEffect\u610F\u5473\u7740\u8FD9\u4E2A\u8BA1\u7B97\u5C5E\u6027\u662F\u5728effect\u4E2D\u4F7F\u7528\n            // \u9700\u8981\u8BA9\u8BA1\u7B97\u5C5E\u6027\u6536\u96C6\u8FD9\u4E2Aeffect\n            // \u7528\u6237\u53D6\u503C\u8FDB\u884C\u4F9D\u8D56\u6536\u96C6\n            trackEffect(this.dep || (this.dep = new Set()))\n        }\n        if (this._ditry) {\n            this._value = this.effect.run() // \u7F13\u5B58\u6267\u884C\u540E\u7684\u7ED3\u679C\n            this._ditry = false // \u610F\u5473\u7740\u53D6\u8FC7\u503C\u4E86\n            return this._value\n        }\n         return this._value\n    }\n     set value(newValue) {\n        this.setter(newValue)\n     } \n}\n\nexport function computed(getterOrOptions) {\n    let onlyGetter = isFunction(getterOrOptions)\n    let getter\n    let setter\n    if (onlyGetter) {\n        getter = onlyGetter\n        setter = noop\n    } else {\n        getter = getterOrOptions.get\n        setter = getterOrOptions.set\n    }\n\n    // getter\u65B9\u6CD5\u5FC5\u987B\u5B58\u5728\n\n    return new ComputedRefImpl(getter, setter)\n}", "import { isFunction, isObject } from \"@vue/shared\";\nimport { ReactiveEffect } from \"./effect\";\nimport { isReactive } from \"./reactive\"\n\n\nfunction traverse(source, s = new Set()) {\n    if(!isObject(source)) {\n        return source\n    }\n    if(s.has(source)) {\n        return source\n    }\n    s.add(source)\n    // \u8003\u8651\u5FAA\u73AF\u5F15\u7528\u7684\u95EE\u9898 \u91C7\u7528set\u89E3\u51B3\u95EE\u9898\n    for(let key in source) {\n        traverse(source[key], s) // \u9012\u5F52\u53D6\u503C\n    }\n    return source\n}\n\nexport function watch(source, cb, options) {\n    doWatch(source, cb, options)\n}\n\nexport function watchEffect(effect, options) {\n    doWatch(effect, null, options)\n}\n\nexport function doWatch(source, cb, {immediate} = {} as any) {\n    let getter;\n    if (isReactive(source)) { // \u5982\u679C\u4F20\u503C\u65F6\u5BF9\u8C61\n        // \u6700\u7EC8\u5904\u7406\u6210\u51FD\u6570\n        getter = () => traverse(source)\n    } else if (isFunction(source)) {  // \u5982\u679C\u4F20\u503C\u662F\u51FD\u6570\n        getter = source\n    }\n    let oldValue\n    let cleanup\n    const onCleanup = (userCb) => {\n        cleanup = userCb\n    }\n    const job = () => {\n        if (cb) {\n            // \u5185\u90E8\u8981\u6389\u7528 cb \u4E5F\u5C31\u662Fwatch\u7684\u56DE\u8C03\n            // console.log('ok')\n            let newValue = effect.run() // \u518D\u6B21\u6389\u7528\u83B7\u53D6\u65B0\u503C\n            if (cleanup) {\n                cleanup()\n            }\n            cb(newValue, oldValue, onCleanup)\n            oldValue = newValue // \u66F4\u65B0\n        } else {\n            effect.run()\n        }\n    }\n    const effect = new ReactiveEffect(getter, job)\n\n    if(immediate) { // \u9ED8\u8BA4\u6267\u884C\u4E00\u6B21\n        return job()\n    }\n\n    oldValue = effect.run() // \u4FDD\u7559\u8001\u503C\n}\n"],
  "mappings": "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",
  "names": ["effect", "ReactiveFlags", "effect"]
}
